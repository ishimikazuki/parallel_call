name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]  # â† ã‚ãªãŸã®CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã«å¤‰æ›´ã—ã¦ãã ã•ã„
    types: [completed]

jobs:
  create-fix-issue:
    # CIãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œï¼ˆ3å›ç›®ä»¥é™ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.run_attempt < 3
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get failed run logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’å–å¾—
          gh run view ${{ github.event.workflow_run.id }} --log-failed > failed_logs.txt 2>&1 || true
          
          # ãƒ­ã‚°ã®æœ€åˆã®3000æ–‡å­—ã‚’å–å¾—
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          head -c 3000 failed_logs.txt >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create fix issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ğŸ¤– @claude CIä¿®æ­£ä¾é ¼: ${{ github.event.workflow_run.name }} failed" \
            --body "## CIè‡ªå‹•ä¿®æ­£ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

          **å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${{ github.event.workflow_run.name }}
          **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.event.workflow_run.head_sha }}
          **ãƒ–ãƒ©ãƒ³ãƒ:** ${{ github.event.workflow_run.head_branch }}
          **å®Ÿè¡ŒURL:** ${{ github.event.workflow_run.html_url }}

          ### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆæŠœç²‹ï¼‰
          \`\`\`
          ${{ steps.logs.outputs.logs }}
          \`\`\`

          ---

          @claude ã“ã®CIã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          **æ‰‹é †:**
          1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åˆ†æã—ã¦æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
          2. æœ€å°é™ã®ä¿®æ­£ã‚’å®Ÿè£…
          3. ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \"fix(ci): [ä¿®æ­£å†…å®¹]\"ï¼‰
          4. ä¿®æ­£å†…å®¹ã‚’PRã§èª¬æ˜

          **æ³¨æ„:**
          - æ—¢å­˜ã®æ©Ÿèƒ½ã‚’å£Šã•ãªã„ã‚ˆã†ã«æ³¨æ„
          - ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°å®Ÿè¡Œã—ã¦ç¢ºèª" \
            --label "auto-fix,ci-failure"
